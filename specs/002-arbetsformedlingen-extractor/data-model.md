# Data Model: Arbetsförmedlingen Job Extractor

**Date**: 2025-10-29  
**Feature**: Arbetsförmedlingen Job Extractor

## Overview

This feature reuses the existing `JobDetails` data model with a new platform enumeration value. No new data structures are required.

## Entities

### JobPlatform Enum (Modified)

**File**: `src/models/JobDetails.ts`

**Change**: Add new enumeration value

```typescript
export enum JobPlatform {
  LINKEDIN = 'LinkedIn',
  INDEED = 'Indeed',
  GLASSDOOR = 'Glassdoor',
  ARBETSFORMEDLINGEN = 'Arbetsförmedlingen',  // NEW
  MANUAL = 'Manual',
}
```

**Rationale**: Using the Swedish name "Arbetsförmedlingen" maintains consistency with how the platform refers to itself and is recognizable to Swedish users.

### JobDetails Interface (No Changes)

**File**: `src/models/JobDetails.ts`

The existing `JobDetails` interface supports all required fields for Arbetsförmedlingen extraction:

```typescript
export interface JobDetails {
  /** Unique identifier (UUID v4) */
  id: string;

  /** Job posting URL */
  url: string;

  /** Company name (1-200 chars) */
  company: string;

  /** Job title/position (1-200 chars) */
  title: string;

  /** Full job description (10-10000 chars) */
  description: string;

  /** Extracted skills from job posting (optional) */
  skills: string[];

  /** Source platform */
  platform: JobPlatform;

  /** Timestamp when job details were extracted */
  extractedAt: Date;

  /** Whether this was manually entered (vs extracted from page) */
  isManual: boolean;
}
```

**Field Mapping** (Arbetsförmedlingen → JobDetails):

| Arbetsförmedlingen Source | JobDetails Field | Notes |
|---------------------------|------------------|-------|
| `h1[data-read-assistance-title]` | `title` | Job posting title |
| `h2#pb-company-name` | `company` | Employer name |
| `.section.job-description` | `description` | Full job description HTML converted to text |
| Qualification sections | `skills` | Extracted from "Kompetenser" and "Språk" sections |
| Current URL | `url` | Page URL including job ID |
| Auto-generated (uuid) | `id` | Generated by extractor |
| `JobPlatform.ARBETSFORMEDLINGEN` | `platform` | Set by extractor |
| Current timestamp | `extractedAt` | Set by extractor |
| `false` | `isManual` | Always false for extracted data |

## Validation Rules

### Existing Constraints (Applied)

From `JOB_DETAILS_CONSTRAINTS` in `src/models/JobDetails.ts`:

- **Company**: 1-200 characters
- **Title**: 1-200 characters  
- **Description**: 10-10000 characters
- **Skills**: Array (0+ items, each string)
- **URL**: Valid URL format
- **Platform**: Must be valid JobPlatform enum value

### Arbetsförmedlingen-Specific Validation

The `ArbetsformedlingenExtractor.validate()` method will check:

```typescript
validate(details: JobDetails): boolean {
  return !!(
    // Required string fields with length constraints
    details.company &&
    details.company.length > 0 &&
    details.company.length <= 200 &&
    
    details.title &&
    details.title.length > 0 &&
    details.title.length <= 200 &&
    
    details.description &&
    details.description.length >= 10 &&
    details.description.length <= 10000 &&
    
    // URL must exist
    details.url &&
    
    // Platform must be correct
    details.platform === JobPlatform.ARBETSFORMEDLINGEN &&
    
    // Skills can be empty array but must be array
    Array.isArray(details.skills)
  );
}
```

## Data Transformations

### 1. HTML to Plain Text (Description)

**Input**: HTML content from `.section.job-description`

```html
<div class="section job-description">
  <p><strong>Säljchef till Västra Götalands län</strong></p>
  <p>Vill du kombinera affärsmannaskap med ledarskap...</p>
  <ul>
    <li>Leda och utveckla ett team av säljare</li>
    <li>Ansvara för försäljningsstrategi</li>
  </ul>
</div>
```

**Output**: Formatted plain text with preserved structure

```text
Säljchef till Västra Götalands län

Vill du kombinera affärsmannaskap med ledarskap...

• Leda och utveckla ett team av säljare
• Ansvara för försäljningsstrategi
```

**Transformation Logic**:

1. Clone element to avoid DOM modifications
2. Replace `<br>` tags with newline characters
3. Add newlines after block elements (`<p>`, `<div>`, `<li>`)
4. Convert list items to bullet points
5. Extract text content
6. Normalize whitespace (collapse multiple spaces, preserve line breaks)
7. Limit to max 3 consecutive newlines

### 2. Skills Array Extraction

**Input**: Multiple qualification sections with different types

```html
<lib-pb-feature-job-qualifications>
  <lib-pb-section-job-qualification>
    <h3>Kompetenser</h3>
    <ul aria-label="Meriterande">
      <li>Försäljningsvana, direktförsäljning konsument</li>
    </ul>
  </lib-pb-section-job-qualification>
  
  <lib-pb-section-job-qualification>
    <h3>Språk</h3>
    <ul aria-label="Krav">
      <li>Svenska</li>
      <li>Engelska</li>
    </ul>
  </lib-pb-section-job-qualification>
  
  <lib-pb-section-job-qualification>
    <h3>Körkort</h3>
    <ul aria-label="Krav">
      <li>B</li>
    </ul>
  </lib-pb-section-job-qualification>
</lib-pb-feature-job-qualifications>
```

**Output**: Flat array of skills

```typescript
[
  "Försäljningsvana, direktförsäljning konsument",
  "Svenska",
  "Engelska"
]
```

**Transformation Logic**:

1. Find all `lib-pb-section-job-qualification` elements
2. For each section, check header text
3. Include sections: "Kompetenser" (Skills), "Språk" (Languages)
4. Exclude sections: "Körkort" (Driver's License) - not a skill
5. Extract all `<li>` text content
6. Trim whitespace
7. Remove duplicates
8. Return as array

### 3. Text Cleaning

**Common Transformations**:

- Remove Angular attributes (`_ngcontent-ng-*`, `_nghost-ng-*`)
- Trim leading/trailing whitespace
- Normalize whitespace within text (single spaces)
- Remove empty lines exceeding 2 consecutive newlines
- Remove special Unicode characters if present
- Decode HTML entities if any

## State Transitions

### Extraction Flow

```text
┌─────────────────────┐
│  Page Loaded        │
│  (Angular Rendered) │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│  Validate URL       │
│  Pattern Match      │
└──────────┬──────────┘
           │
           ├─── NO ──▶ Return null / Use ManualExtractor
           │
           YES
           │
           ▼
┌─────────────────────┐
│  Extract Required   │
│  - Company          │
│  - Title            │
│  - Description      │
└──────────┬──────────┘
           │
           ├─── MISSING ──▶ Throw ExtractionError
           │
           COMPLETE
           │
           ▼
┌─────────────────────┐
│  Extract Optional   │
│  - Skills           │
│  - Location         │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│  Create JobDetails  │
│  - Generate UUID    │
│  - Set timestamp    │
│  - Set platform     │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│  Validate Data      │
│  Check constraints  │
└──────────┬──────────┘
           │
           ├─── FAIL ──▶ Throw ExtractionError
           │
           PASS
           │
           ▼
┌─────────────────────┐
│  Return JobDetails  │
└─────────────────────┘
```

## Relationships

### Component Diagram

```text
┌──────────────────────────────────────┐
│   ArbetsformedlingenExtractor        │
│   (implements JobExtractor)          │
├──────────────────────────────────────┤
│   + id: string                       │
│   + name: string                     │
│   + urlPatterns: RegExp[]            │
├──────────────────────────────────────┤
│   + canExtract(url): boolean         │
│   + extract(doc): JobDetails|null    │
│   + validate(details): boolean       │
│   - extractCompany(doc): string      │
│   - extractTitle(doc): string        │
│   - extractDescription(doc): string  │
│   - extractSkills(doc): string[]     │
└──────────────────────────────────────┘
                  │
                  │ creates
                  ▼
┌──────────────────────────────────────┐
│          JobDetails                  │
├──────────────────────────────────────┤
│   + id: string                       │
│   + url: string                      │
│   + company: string                  │
│   + title: string                    │
│   + description: string              │
│   + skills: string[]                 │
│   + platform: JobPlatform            │
│   + extractedAt: Date                │
│   + isManual: boolean                │
└──────────────────────────────────────┘
                  │
                  │ uses enum
                  ▼
┌──────────────────────────────────────┐
│         JobPlatform (enum)           │
├──────────────────────────────────────┤
│   LINKEDIN                           │
│   INDEED                             │
│   GLASSDOOR                          │
│   ARBETSFORMEDLINGEN ← NEW           │
│   MANUAL                             │
└──────────────────────────────────────┘
```

### Registration Flow

```text
┌──────────────────────────────────────┐
│     Content Script Initialization    │
│     (src/services/jobExtractor/      │
│      client.ts)                      │
└──────────────────────────────────────┘
                  │
                  │ creates
                  ▼
┌──────────────────────────────────────┐
│      ExtractorRegistry               │
└──────────────────────────────────────┘
                  │
                  │ register()
                  ▼
         ┌────────┴────────┐
         │                 │
         ▼                 ▼
┌──────────────────┐ ┌──────────────────────────┐
│ LinkedInExtractor│ │ArbetsformedlingenExtractor│ ← NEW
└──────────────────┘ └──────────────────────────┘
         │                 │
         └────────┬────────┘
                  │
                  │ findExtractor(url)
                  ▼
┌──────────────────────────────────────┐
│   Returns matching extractor for    │
│   current page URL                   │
└──────────────────────────────────────┘
```

## Storage Considerations

**No Changes Required**: JobDetails storage mechanism (browser local storage, encryption) remains unchanged. The new ARBETSFORMEDLINGEN platform value is simply another enum value that fits within existing storage structure.

## Summary

This feature introduces minimal data model changes:

- **1 new enum value**: `JobPlatform.ARBETSFORMEDLINGEN`
- **No new interfaces**: Reuses existing `JobDetails`
- **No new storage**: Uses existing storage mechanisms
- **Standard transformations**: HTML→text, array extraction (similar to LinkedIn)

The data model design prioritizes reuse and consistency with existing extractors.
